(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{137:function(e,t,n){"use strict";n.r(t),t.default="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMkAAADeCAYAAACXFSQmAAAFDXRFWHRteGZpbGUAJTNDbXhmaWxlJTIwaG9zdCUzRCUyMmFwcC5kaWFncmFtcy5uZXQlMjIlMjBtb2RpZmllZCUzRCUyMjIwMjAtMDYtMTFUMjIlM0E0NyUzQTI0Ljc2NVolMjIlMjBhZ2VudCUzRCUyMjUuMCUyMChXaW5kb3dzJTIwTlQlMjAxMC4wJTNCJTIwV2luNjQlM0IlMjB4NjQpJTIwQXBwbGVXZWJLaXQlMkY1MzcuMzYlMjAoS0hUTUwlMkMlMjBsaWtlJTIwR2Vja28pJTIwQ2hyb21lJTJGODMuMC40MTAzLjk3JTIwU2FmYXJpJTJGNTM3LjM2JTIyJTIwdmVyc2lvbiUzRCUyMjEzLjIuMyUyMiUyMGV0YWclM0QlMjJBTjVLSUlTOWFoMG9Pa1MzLUZJNCUyMiUyMHR5cGUlM0QlMjJnb29nbGUlMjIlM0UlM0NkaWFncmFtJTIwaWQlM0QlMjJ3cHp4YkdWOGRWWkRGdUF6SzJxNSUyMiUzRTFaWmRiOW93RklaJTJGVFc0bWJVcHNDT0Z5c0hhN1dOZEpUSnEwT3ljMmlZVVRwOFlwc0YlMkIlMkZZJTJCeEFRbHhLSlpCV3VNang0NCUyRmtuUGUxN0FEUHklMkIxWFJlcmlRVkltQWhUU2JZQyUyRkJBamhhWWpoWWNqT2tzbG9iRUd1T0xVb09vSUYlMkY4c2NEQjF0T0dYcjNrQXRwZEM4N3NOTVZoWExkSThScGVTbVAyd3BSZiUyQnROY25aQUN3eUlvYjBONmU2c0RSQmt5UCUyRnhuaGV0RyUyQk80cW50S1VrNzJHV3lMZ2lWbXc3Q2R3R2VLeW0xamNydG5BbFR2TFl1ZHQ3OUM3MkhEMU9zMHBkTVFIYkNNeEdOeSUyQjJCMUFBV1R3MnM0YjVSNzlyRTRYTnJFMlpOQ28lMkZacHVDYUxXcVNHYllCcllFVnVoVFFpaUJNWlZOUlJyJTJCbkIwQ3lWYTRNZld5MDRCVnpuQksxZW9SbHVEYUdDRCUyQkY0ejVFZTJwR3JxMFhSaUhFU3k3RVhBcXBBRlRTTERaYmF5VlhySVVCd2dsS2NSeWJ3YkxTSFI3dWY4Q2ZtZEljbFAwc2VGNUJuNVltQ2VK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"},91:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return r})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return p}));var a=n(2),i=n(6),o=(n(0),n(96)),l={title:"Game Map"},r={unversionedId:"functionality/map",id:"functionality/map",isDocsHomePage:!1,title:"Game Map",description:"Note: At the time of this writing, all code examples are in Java. This is to be updated to Kotlin later.",source:"@site/docs/functionality/map.md",slug:"/functionality/map",permalink:"/docs/functionality/map",editUrl:"https://github.com/RuneDocs/Documentation/edit/master/docs/functionality/map.md",version:"current",sidebar:"someSidebar",previous:{title:"Functionality",permalink:"/docs/functionality"},next:{title:"Glossary",permalink:"/docs/naming/glossary"}},c=[{value:"Layout",id:"layout",children:[]},{value:"Build Area",id:"build-area",children:[]},{value:"Instancing",id:"instancing",children:[]}],s={rightToc:c};function p(e){var t=e.components,l=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},s,l,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Note"),": At the time of this writing, all code examples are in Java. This is to be updated to Kotlin later."),Object(o.b)("h2",{id:"layout"},"Layout"),Object(o.b)("p",null,"The game map in RuneScape is made out of a three dimensional box of exactly four altitudes or height levels where each height level holds a symmetrical two dimensional grid of 16384 x 16384 tiles. Each grid on a height level is divided into two separate static units:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Map squares"),Object(o.b)("li",{parentName:"ul"},"Zones")),Object(o.b)("p",null,"A map square is a 64 x 64 area of tiles. In contrast with a map square, a zone is a more fine-grained area consisting of 8 x 8 tiles. This means that each map square can hold up to 8 x 8 zones."),Object(o.b)("p",null,Object(o.b)("img",{alt:"Game Map",src:n(137).default})),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("em",{parentName:"li"},"Credits to Greg for the illustration"))),Object(o.b)("p",null,"The RuneScape game cache stores all objects, obstacles, buildings, tiles and such per map squares. For efficiency however, the server should store all deserialized objects per zone. This allows the server to efficiently read-and manipulate zones to provide certain features of the game. This includes (but is not limited to) instancing (player owned houses, minigames, random events), searching for nearby players / npcs etc."),Object(o.b)("p",null,"Conceptually, the grid of the game world can be modeled as a three dimensional array of:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"private static final int\n    SIZE = 16384,\n    ZONE_COUNT = SIZE / 8, // 16384 tiles on each axis divided by 8 tiles per zone\n    ALTITUDE_COUNT = 4;\n\nprivate final Zone[][][] zones = new Zone[ALTITUDE_COUNT][ZONE_COUNT][ZONE_COUNT];\n")),Object(o.b)("p",null,"Alternative and arguably more memory efficient ways involve using a ",Object(o.b)("inlineCode",{parentName:"p"},"HashMap")," but that's a mere detail."),Object(o.b)("h2",{id:"build-area"},"Build Area"),Object(o.b)("p",null,"The build area is a limited view of the map the player can roam freely. Once the player reaches the edge of the build area, a rebuild is required which is to update the player's view. The build area consists of 104 x 104 tiles and showcases events that are currently happening in the game in that particular part of the map. As the build area consists of 104 x 104 tiles and each zone being 8 x 8 tiles, our build area consists of 13 x 13 zones. When a rebuild occurs, the build area recenters itself around the player's current position. The center of the build area is calculated by dividing the view in two which equals 6 zones (48 tiles, exclusively). This means that the player's position local to the build area, right after a rebuild will always be in zone 7, 7 (48, 48)."),Object(o.b)("p",null,"The margin that defines the edges of the build area is 16 tiles, which means that we can check if a rebuild is required by:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"private boolean rebuildRequired(Position position) {\n    int x = getX(position);\n    int z = getZ(position);\n\n    boolean reachedLowerEdge = x < 16 || z < 16;\n    boolean reachedUpperEdge = x >= 88 || z >= 88;\n\n    return reachedLowerEdge || reachedUpperEdge;\n}\n\npublic int getX(Position p) {\n    return p.getX() - ((lastRebuild.getZoneX() - RADIUS) * Zone.SIZE);\n}\n\npublic int getZ(Position p) {\n    return p.getZ() - ((lastRebuild.getZoneZ() - RADIUS) * Zone.SIZE);\n}\n")),Object(o.b)("p",null,"The methods ",Object(o.b)("inlineCode",{parentName:"p"},"getX()")," and ",Object(o.b)("inlineCode",{parentName:"p"},"getZ()")," get the player's current x and z coordinates within the build area, respectively. As is noticable by the ",Object(o.b)("inlineCode",{parentName:"p"},"lastRebuild")," field, the ",Object(o.b)("inlineCode",{parentName:"p"},"BuildArea")," keeps track of where it last has been updated to compare whether it should rebuild again using a given ",Object(o.b)("inlineCode",{parentName:"p"},"Position")," as its new center."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"private static final int RADIUS = 6;\n\nprivate void doRebuild(World world, Position position) {\n    int centerZoneX = position.getZoneX();\n    int centerZoneZ = position.getZoneZ();\n\n    int bottomLeftZoneX = centerZoneX - RADIUS;\n    int bottomLeftZoneZ = centerZoneZ - RADIUS;\n\n    for (int altitude = 0; altitude < ALTITUDE_COUNT; altitude++) {\n        for (int localZoneX = 0; localZoneX < ZONE_COUNT; localZoneX++) {\n            for (int localZoneZ = 0; localZoneZ < ZONE_COUNT; localZoneZ++) {\n                int zoneX = bottomLeftZoneX + localZoneX;\n                int zoneZ = bottomLeftZoneZ + localZoneZ;\n\n                zones[altitude][localZoneX][localZoneZ] = world.get(altitude, zoneX, zoneZ);\n            }\n        }\n    }\n\n    lastRebuild = position;\n\n    notifyRebuild(centerZoneX, centerZoneZ);\n}\n")),Object(o.b)("p",null,"A rebuild will also involve refreshing the entities ALL zones within an arbitrary radius in the new build area. Every element within each zone (floor item stacks and objects) is visually removed from the client and re-applied. The server doesn't actually manually remove each element per-packet but rather sends a packet that clears an entire zone of its elements. After sending this packet, all elements that are still within that zone are re-sent. Post-rebuild the server will keep track of updates within the avatar's 7 x 7 area of zones until another rebuild occurs."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"private void refreshAllZones(Position center) {\n    clearPendingUpdates();\n\n    for (int localZoneX = 0; localZoneX < ZONE_COUNT; localZoneX++) {\n        for (int localZoneZ = 0; localZoneZ < ZONE_COUNT; localZoneZ++) {\n            Zone zone = zones[center.getAltitude()][localZoneX][localZoneZ];\n            if (zone == null) {\n                 continue;\n            }\n\n            refreshZone(zone);\n        }\n    }\n}\n\nprivate void refreshZone(Zone zone) {\n    clearZone(zone.getPosition());\n\n    for (int tileX = 0; tileX < Zone.SIZE; tileX++) {\n        for (int tileZ = 0; tileZ < Zone.SIZE; tileZ++) {\n            FloorItemStack itemStack = zone.getFloorItemStack(tileX, tileZ);\n            if (itemStack == null || itemStack.isEmpty()) {\n                continue;\n            }\n\n            for (Item item : itemStack) {\n                spawnFloorItem(itemStack.getPosition(), item);\n            }\n        }\n    }\n\n    Collection<Loc> dynamicLocs = zone.getLocs();\n    for (Loc loc : dynamicLocs) {\n        spawnLoc(loc);\n    }\n}\n")),Object(o.b)("h2",{id:"instancing"},"Instancing"),Object(o.b)("p",null,"In the past, RuneScape private servers would attempt to emulate instancing by placing players on specific height levels by using a bit value overflow trick that the client ended up treating as the bottom height level (0). However, this isn't how Jagex solved the instancing problem. An instance is generated by searching the map for an empty spot. The spot should be the size of the instance in tiles. So for example, if an instance such as the Drill Demon event occupies exactly one map square, we are to copy over all 8 x 8 zones within that map square to our empty area. The empty area may be at 0,0 which means that our event map is copied over to 0,0 and our player is to be teleported there as well when the event occurs. Once the player is done with the event, the player is teleported out of there back to the main land and the temporary instance is cleared from our reserved area to be reused by another event or instance. ",Object(o.b)("strong",{parentName:"p"},"Note")," that OldSchool RuneScape starts searching for empty spots at an X coordinate of 6400 as CS2 scripts require this for minigames such as Theatre of Blood."),Object(o.b)("p",null,"In order to create an instance, the game searches for an empty spot that zones can be copied over to. In many cases, the game will prematurely calculate how many zones or map squares an instance will occupy. This may vary however in areas such as Chambers of Xeric and Theatre of Blood."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"private static final int\n    OFFSET_X = 6400,\n    OFFSET_Z = 0;\n\npublic Position findEmptyArea(int altitude, int width, int length) {\n    int mapSpanX = width / MapSquare.SIZE;\n    int mapSpanZ = length / MapSquare.SIZE;\n\n    VerticalSearch:\n    for (int z = OFFSET_Z; z < SIZE; z += length) {\n        HorizontalSearch:\n        for (int x = OFFSET_X; x < SIZE; x += width) {\n            int mapX = x / MapSquare.SIZE;\n            int mapZ = z / MapSquare.SIZE;\n\n            for (int i = mapX; i < mapX + mapSpanX; i++) {\n                int zoneX = i * Zone.SIZE;\n                int zoneZ = mapZ * Zone.SIZE;\n\n                Zone zone = zones[altitude][zoneX][zoneZ];\n                if (zone != null) {\n                    continue HorizontalSearch;\n                }\n            }\n\n            for (int i = mapZ; i < mapZ + mapSpanZ; i++) {\n                int zoneX = mapX * Zone.SIZE;\n                int zoneZ = i * Zone.SIZE;\n\n                Zone zone = zones[altitude][zoneX][zoneZ];\n                if (zone != null) {\n                    continue VerticalSearch;\n                }\n            }\n\n            return Position.abs(x, z, altitude);\n        }\n    }\n\n    return null;\n}\n")),Object(o.b)("p",null,"Once a suitable area has been found somewhere on the map, the target zone can be copied. It is important that the collision matrix is included in the copy."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"public Zone copy(Position position, Rotation rotation) {\n    Zone original = Objects.requireNonNull(get(position));\n    Zone copy = Zone.at(true, position, rotation);\n    for (int x = 0; x < Zone.SIZE; x++) {\n        for (int z = 0; z < Zone.SIZE; z++) {\n            copy.getCollisionMatrix().set(x, z, original.getCollisionMatrix().get(x, z));\n        }\n    }\n\n    return copy;\n}\n")),Object(o.b)("p",null,"And the copied zone can then be pasted at the designated location of our empty area."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"public void paste(Position target, Zone zone) {\n    if (get(target) != null) {\n        throw new IllegalArgumentException();\n    }\n\n    zone.setPosition(Position.abs(target.getZoneX() * Zone.SIZE, target.getZoneZ() * Zone.SIZE, target.getAltitude()));\n    put(zone);\n}\n")),Object(o.b)("p",null,"A zone can also be rotated in our dynamic construct (for rooms in Player Owned Houses). This means that every flag in the collision matrix has to be shifted by X degrees as well. For example, clockwise rotating a matrix by 90 degrees can be implemented as:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"public void rotate() {\n    int[][] updated = new int[getWidth()][getLength()];\n    for (int x = 0; x < getWidth(); ++x) {\n        for (int z = 0; z < getLength(); ++z) {\n            updated[x][z] = flags[getWidth() - z - 1][x];\n        }\n    }\n\n    flags = updated;\n}\n")),Object(o.b)("p",null,"The client then needs to showcase these changes. There are two types of packets that the client supports. These are called static rebuild and dynamic rebuild, respectively. The static rebuild packet is used when there are no dynamic changes (such as zones being copied over) to the map. This will tell the client to draw the regular map based on a given tile position. For most of the time, the static rebuild packet is used."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"public static EventEncoder<BuildAreaStaticRebuild> encoder() {\n    return (out, evt) -> {\n        out.writeShort(evt.getCenterZoneX());\n        out.writeShort(evt.getCenterZoneZ());\n\n        out.writeShort(evt.getKeySets().size());\n        for (MapSquareConfig.KeySet keySet : evt.getKeySets()) {\n            for (int key : keySet) {\n                out.writeInt(key);\n            }\n        }\n    };\n}\n")),Object(o.b)("p",null,"The dynamic rebuild packet on the other hand will draw the zones that have been copied over to our empty area."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"    public static EventEncoder<BuildAreaDynamicRebuild> encoder() {\n        return (out, evt) -> {\n            out\n                    .writeBoolean(evt.requireImmediateRebuild())\n                    .writeShort(evt.getCenterZoneX())\n                    .writeShort(evt.getCenterZoneZ())\n                    .writeShort(evt.getKeySets().size());\n\n            bitBlock(BitAccessType.WRITE, out, bitIndex -> {\n                for (int altitude = 0; altitude < evt.getPalette().getHeight(); altitude++) {\n                    for (int localZoneX = 0; localZoneX < evt.getPalette().getWidth(); localZoneX++) {\n                        for (int localZoneZ = 0; localZoneZ < evt.getPalette().getLength(); localZoneZ++) {\n                            BuildAreaPalette.Zone zone = evt.getPalette().get(altitude, localZoneX, localZoneZ);\n\n                            writeBit(out, bitIndex, zone != null);\n                            if (zone != null) {\n                                writeBits(out, bitIndex, 26, zone.getAltitude() << 24 |\n                                        zone.getRotation() << 1 |\n                                        zone.getOriginX() << 14 |\n                                        zone.getOriginZ() << 3);\n                            }\n                        }\n                    }\n                }\n            });\n\n            for (MapSquareConfig.KeySet keySet : evt.getKeySets()) {\n                for (int key : keySet) {\n                    out.writeInt(key);\n                }\n            }\n        };\n    }\n")))}p.isMDXComponent=!0},96:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var a=n(0),i=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=i.a.createContext({}),p=function(e){var t=i.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return i.a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},h=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),u=p(n),h=a,b=u["".concat(l,".").concat(h)]||u[h]||d[h]||o;return n?i.a.createElement(b,r(r({ref:t},s),{},{components:n})):i.a.createElement(b,r({ref:t},s))}));function b(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=h;var r={};for(var c in t)hasOwnProperty.call(t,c)&&(r[c]=t[c]);r.originalType=e,r.mdxType="string"==typeof e?e:a,l[1]=r;for(var s=2;s<o;s++)l[s]=n[s];return i.a.createElement.apply(null,l)}return i.a.createElement.apply(null,n)}h.displayName="MDXCreateElement"}}]);